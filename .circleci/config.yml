version: 2.1

orbs:
  aws-eks: circleci/aws-eks@2.2.0
  kubernetes: circleci/kubernetes@1.3

jobs:
  test-cluster:
    machine:
      image: ubuntu-2004:current
    parameters:
      cluster-name:
        description: |
          Name of the EKS cluster
        type: string
    steps:
      - checkout
      - run: sudo apt-get update && sudo apt-get install gettext-base
      - run: 
          name: Build and publish Docker Image
          command: |
            sudo docker build .
            sudo docker tag getting-started brianoh1979/getting-started:latest
            sudo docker push brianoh1979/getting-started:latest
      - kubernetes/install:
          kubectl-version: v1.22.0
      - run:
          name: Update manifest
          command: |
            cat .k8s/templates/vamp-demo.yaml | envsubst > .k8s/templates/vamp-demo-final.yaml
            cat .k8s/templates/vamp-demo-final.yaml
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: << parameters.cluster-name >>
          aws-region: ${AWS_REGION}
          aws-profile: ${AWS_PROFILE}
      - run:   
           command: |
             kubectl get services
           name: Test cluster
      - run: kubectl get namespace
      - run:
          name: kubectl apply
          command: kubectl apply -f .k8s/templates/vamp-demo-final.yaml -n production

workflows:
  deployment:
    jobs:
      - test-cluster:
          cluster-name: brianoh-vamp5
